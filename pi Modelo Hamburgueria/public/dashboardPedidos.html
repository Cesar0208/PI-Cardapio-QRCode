<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Completo de Pedidos - BurguerPI</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5;      /* Índigo (Principal) */
            --secondary-color: #1e293b;    /* Cinza Escuro (Texto) */
            --warning-color: #f59e0b;      /* Amarelo (Preparo) */
            --success-color: #10b981;      /* Verde (Entregue) */
            --info-color: #0ea5e9;         /* Ciano (Em Rota) */
            --danger-color: #ef4444;       /* Vermelho (Cancelado) */
            --bg-light: #f8fafc;           /* Fundo mais claro */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-light);
            color: var(--secondary-color);
        }

        /* Navbar e Cabeçalho */
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Card Principal */
        .data-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            height: 100%;
        }

        /* Tabela de Pedidos */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .table > :not(caption) > * > * {
            padding: 12px 15px; /* Mais espaço interno */
        }

        /* Cores dos status na tabela */
        .status-badge {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            min-width: 100px; /* Largura mínima para uniformidade */
            display: inline-block;
            text-align: center;
        }

        .status-badge.novo { background-color: #0ea5e9; color: white; }
        .status-badge.preparo { background-color: #fef3c7; color: var(--warning-color); }
        .status-badge.enviado { background-color: #dbeafe; color: var(--info-color); }
        .status-badge.entregue { background-color: #d1fae5; color: var(--success-color); }
        .status-badge.cancelado { background-color: #fee2e2; color: var(--danger-color); }

        /* KPI Card */
        .kpi-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            height: 100%;
        }

        .kpi-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }

        .kpi-title {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
        }

        /* Estilo para o modal de detalhes */
        .modal-body strong {
            color: var(--primary-color);
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand logo ms-2 text-primary" href="#">
                <i class="fas fa-list-check me-2"></i>Gerenciamento de Pedidos
            </a>
            <span class="navbar-text text-muted me-3 d-none d-md-block">
                Dados atualizados em: <span id="lastUpdated" class="fw-semibold"></span>
            </span>
        </div>
    </nav>

    <main class="container-fluid py-4">
        
        <h1 class="h4 text-dark mb-4">Visão Geral Operacional</h1>

        <div class="row g-4 mb-4">
            
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-concierge-bell fa-2x text-warning me-3"></i>
                        <div>
                            <div class="kpi-title">Em Preparo (Cozinha)</div>
                            <div class="kpi-value text-warning" id="kpi-em-preparo"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-motorcycle fa-2x text-info me-3"></i>
                        <div>
                            <div class="kpi-title">Em Rota (Entrega)</div>
                            <div class="kpi-value text-info" id="kpi-em-rota"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x text-success me-3"></i>
                        <div>
                            <div class="kpi-title">Entregues (Hoje)</div>
                            <div class="kpi-value text-success" id="kpi-entregues-hoje"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card">
                    <label for="date-range-filter" class="form-label kpi-title">Filtro Rápido de Data</label>
                    <select class="form-select border-0 bg-light fw-bold" id="date-range-filter" onchange="applyKpiFilter(this.value)">
                        <option value="today">Hoje</option>
                        <option value="7days">Últimos 7 Dias</option>
                        <option value="30days">Últimos 30 Dias</option>
                        <option value="all" selected>Todos os Tempos</option>
                    </select>
                </div>
            </div>
            
        </div>

        <div class="row g-4 mb-4">
            
            <div class="col-12">
                <div class="data-card">
                    <h5 class="card-title text-dark mb-3"><i class="fas fa-table me-2"></i>Todos os Pedidos (Consulta Completa)</h5>
                    
                    <div class="row mb-3 gx-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" placeholder="Buscar ID, Cliente ou CPF..." onkeyup="applyTableFilters()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="status-filter" onchange="applyTableFilters()">
                                <option value="all" selected>Filtrar por Status...</option>
                                <option value="novo">Novo / Recebido</option>
                                <option value="preparo">Em Preparo</option>
                                <option value="enviado">Em Rota / Enviado</option>
                                <option value="entregue">Entregue / Concluído</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" onchange="applyTableFilters()">
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-danger w-100" onclick="resetTableFilters()">
                                <i class="fas fa-trash-can me-2"></i>Limpar Filtros
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Data & Hora</th>
                                    <th>Cliente (CPF)</th>
                                    <th>Valor</th>
                                    <th>Pagamento</th>
                                    <th>Status</th>
                                    <th>Ações</th> </tr>
                            </thead>
                            <tbody id="pedidos-table-body">
                            </tbody>
                        </table>
                    </div>
                    <small class="text-muted mt-2 d-block">Clique em "Ver" para abrir os detalhes do pedido.</small>
                </div>
            </div>

        </div>
    </main>

    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="orderDetailsModalLabel"><i class="fas fa-scroll me-2"></i>Detalhes do Pedido <span id="modal-order-id"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <p class="mb-1">Cliente:</p>
                            <h4 id="modal-cliente" class="text-secondary fw-bold"></h4>
                            <p class="mb-1">Endereço de Entrega:</p>
                            <p id="modal-endereco" class="fw-semibold text-muted"></p>
                        </div>
                        <div class="col-md-6 mb-3 border-start">
                            <p class="mb-1">Status Atual:</p>
                            <h4 id="modal-status" class="mb-3"></h4>
                            <p class="mb-1">Funcionário Responsável:</p>
                            <p id="modal-funcionario" class="fw-semibold text-muted"></p>
                        </div>
                    </div>
                    
                    <hr>

                    <h6>Itens do Pedido:</h6>
                    <ul class="list-group list-group-flush" id="modal-itens">
                        </ul>

                    <h6 class="mt-4">Observações:</h6>
                    <p id="modal-obs" class="alert alert-light border-start border-warning border-4">Nenhuma observação.</p>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success"><i class="fas fa-print me-1"></i> Imprimir Comanda</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        window.applyTableFilters = function() {
                const statusFilter = document.getElementById('status-filter').value;
                const searchFilter = document.querySelector('.row.mb-3 input[type="text"]').value.toLowerCase();
                const dateFilter = document.querySelector('.row.mb-3 input[type="date"]').value;
                
                const rows = document.querySelectorAll('#pedidos-table-body tr');

                rows.forEach(row => {
                    const rowStatus = row.getAttribute('data-status');
                    const rowText = row.textContent.toLowerCase();
                    const rowDate = row.getAttribute('data-date');
                    let showRow = true;

                    if (statusFilter !== 'all' && rowStatus !== statusFilter) { showRow = false; }
                    if (searchFilter && !rowText.includes(searchFilter)) { showRow = false; }
                    if (dateFilter && rowDate !== dateFilter) { showRow = false; }

                    row.style.display = showRow ? '' : 'none';
                });
            }

             window.resetTableFilters = function() {
                document.getElementById('status-filter').value = 'all';
                document.querySelector('.row.mb-3 input[type="text"]').value = '';
                document.querySelector('.row.mb-3 input[type="date"]').value = '';
                applyTableFilters();
            }

        const DETAILS_API_URL = 'http://localhost:3000/pedidos/'; // URL base
        const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));

        function getStatusModalHtml(status) {
            const statusMap = {
                'novo': { text: 'Novo', class: 'text-primary' },
                'preparo': { text: 'Em Preparo', class: 'text-warning' },
                'enviado': { text: 'Em Rota', class: 'text-info' },
                'entregue': { text: 'Entregue', class: 'text-success' },
                'cancelado': { text: 'Cancelado', class: 'text-danger' },
            };
            
            const info = statusMap[status] || { text: status, class: 'text-muted' };
            
            return `<h4 class="${info.class} fw-bold">${info.text}</h4>`;
        }

        async function showOrderDetails(orderId) {
            const url = DETAILS_API_URL + orderId;
            
            // Elementos do Modal
            const orderIdEl = document.getElementById('modal-order-id');
            const clienteEl = document.getElementById('modal-cliente');
            const statusEl = document.getElementById('modal-status');
            const funcionarioEl = document.getElementById('modal-funcionario');
            const enderecoEl = document.getElementById('modal-endereco');
            const obsEl = document.getElementById('modal-obs');
            const itensEl = document.getElementById('modal-itens');

            // Limpa e define ID inicial
            orderIdEl.textContent = `#${orderId}`;
            clienteEl.textContent = 'Carregando...';
            itensEl.innerHTML = '<li class="list-group-item">Buscando itens...</li>';
            
            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Falha: HTTP ${response.status}`);
                }

                const result = await response.json();
                const data = result.data;

                if (!data) {
                    throw new Error('Dados não encontrados.');
                }

                // 1. DADOS PRINCIPAIS
                clienteEl.textContent = `${data.ClienteNome} (${data.ClienteCPF})`;
                funcionarioEl.textContent = data.FuncionarioNome || 'Não atribuído';
                enderecoEl.textContent = data.EnderecoEntrega || 'Endereço não disponível';
                
                // 2. STATUS
                statusEl.innerHTML = getStatusModalHtml(data.Status);
                
                // 3. OBSERVAÇÕES
                if (data.Observacoes && data.Observacoes.trim() !== '') {
                    obsEl.textContent = data.Observacoes;
                    obsEl.classList.remove('alert-light');
                    obsEl.classList.add('alert-warning');
                } else {
                    obsEl.textContent = 'Nenhuma observação.';
                    obsEl.classList.remove('alert-warning');
                    obsEl.classList.add('alert-light');
                }
                
                // 4. ITENS DO PEDIDO
                itensEl.innerHTML = '';
                if (data.ItensDetalhes) {
                    // Dividir a string de itens (separador '||' definido no SQL)
                    const itensArray = data.ItensDetalhes.split('||');
                    
                    itensArray.forEach(itemStr => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        li.textContent = itemStr.trim();
                        
                        // Exemplo: se você tivesse o preço no SQL, poderia adicionar aqui
                        // li.innerHTML = `${itemStr.trim()} <span class="badge bg-secondary">R$ XX,XX</span>`;
                        
                        itensEl.appendChild(li);
                    });
                } else {
                    itensEl.innerHTML = '<li class="list-group-item text-muted">Nenhum item encontrado.</li>';
                }

                // Se o modal não estava aberto, ele abrirá automaticamente via data-bs-toggle (no botão)
                
            } catch (error) {
                console.error(`Erro ao carregar modal do pedido ${orderId}:`, error.message);
                clienteEl.textContent = 'Erro ao carregar dados.';
                funcionarioEl.textContent = '';
                statusEl.innerHTML = getStatusModalHtml('erro');
                itensEl.innerHTML = '<li class="list-group-item text-danger">Falha ao conectar ou buscar dados.</li>';
            }
        }


        const PEDIDOS_API_URL = 'http://localhost:3000/pedidos/listar';
        const TABLE_BODY_ID = 'pedidos-table-body';

        function getStatusBadgeHtml(status) {
            const statusMap = {
                'novo': { text: 'Novo', class: 'novo' },
                'preparo': { text: 'Em Preparo', class: 'preparo' },
                'enviado': { text: 'Em Rota', class: 'enviado' },
                'entregue': { text: 'Entregue', class: 'entregue' },
                'cancelado': { text: 'Cancelado', class: 'cancelado' },
            };
            
            const info = statusMap[status] || { text: status, class: 'default' };
            
            // Retorna o HTML do Badge
            return `<span class="status-badge ${info.class}">${info.text}</span>`;
        }

        /**
         * Função principal que busca os pedidos e preenche a tabela.
         */
        async function carregarTabelaPedidos() {
            const tbody = document.getElementById(TABLE_BODY_ID);
            if (!tbody) {
                console.error(`Elemento com ID '${TABLE_BODY_ID}' não encontrado.`);
                return;
            }

            // Limpa o conteúdo existente da tabela antes de carregar
            tbody.innerHTML = '<tr><td colspan="7">Carregando pedidos...</td></tr>'; 

            try {
                const response = await fetch(PEDIDOS_API_URL);
                
                if (!response.ok) {
                    throw new Error(`Falha na requisição: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.status !== 'success' || !Array.isArray(result.data)) {
                    throw new Error('Formato de dados do servidor inválido.');
                }

                const pedidos = result.data;
                tbody.innerHTML = ''; // Limpa novamente, agora para inserir os dados

                if (pedidos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum pedido encontrado no momento.</td></tr>';
                    return;
                }

                pedidos.forEach(pedido => {
                    const dataHora = new Date(pedido.Horario_Pedido).toLocaleString('pt-BR', {
                        day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit'
                    });

                    // Cria a linha (tr)
                    const row = tbody.insertRow();
                    
                    // Coluna ID
                    row.insertCell().textContent = `#${pedido.ID}`;
                    
                    // Coluna Data & Hora
                    row.insertCell().textContent = dataHora;

                    // Coluna Cliente (Nome e CPF)
                    row.insertCell().textContent = `${pedido.ClienteNome} (${pedido.ClienteCPF.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '***.$2.***-$4')})`; 

                    // Coluna Valor (Formato R$)
                    row.insertCell().textContent = `R$ ${pedido.Valor}`;

                    // Coluna Pagamento
                    row.insertCell().textContent = pedido.Forma_Pagamento;

                    // Coluna Status (Badge HTML)
                    row.insertCell().innerHTML = getStatusBadgeHtml(pedido.Status);

                    // Coluna Ações (Botão Ver)
                    row.insertCell().innerHTML = `
                        <button class="btn btn-sm btn-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#orderDetailsModal" 
                                onclick="showOrderDetails(${pedido.ID})">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    `;
                    
                    // Opcional: Adicionar atributos de dados para o modal
                    row.setAttribute('data-id', pedido.ID);
                    row.setAttribute('data-status', pedido.Status);
                    // ... adicione outros atributos de dados se o modal precisar deles ...
                });

            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-danger text-center">Falha ao carregar dados. Tente novamente.</td></tr>';
            }
        }

        // Chamar a função para popular a tabela ao carregar a página
        document.addEventListener('DOMContentLoaded', carregarTabelaPedidos);

        const BASE_API_URL = 'http://localhost:3000/api/pedidos/contagem';
        async function atualizarKPI(status, elementId) {
            const elemento = document.getElementById(elementId);
            
            // Define um valor temporário enquanto busca
            if (elemento) elemento.textContent = '...'; 
            
            const url = `${BASE_API_URL}?status=${status}`;

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const contagem = data?.contagem;

                if (contagem === undefined) {
                    throw new Error("Resposta do servidor com formato inválido.");
                }
                
                // Atualiza o elemento no HTML com o novo valor
                if (elemento) {
                    elemento.textContent = contagem;
                }

            } catch (error) {
                if (elemento) {
                    elemento.textContent = 'Erro';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const formattedTime = now.toLocaleDateString('pt-BR') + ' às ' + now.toLocaleTimeString('pt-BR').substring(0, 5);
            document.getElementById('lastUpdated').textContent = formattedTime;
            
            atualizarKPI('preparo', 'kpi-em-preparo'); 
            atualizarKPI('enviado', 'kpi-em-rota'); 
            atualizarKPI('entregue', 'kpi-entregues-hoje'); 
        });
    </script>

</body>
</html>